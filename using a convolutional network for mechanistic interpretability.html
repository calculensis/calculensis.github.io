<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <title>    using a convolutional network for mechanistic interpretability
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href='https://fonts.googleapis.com/css?family=Gentium+Book+Basic|Merriweather:400,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://calculensis.github.io/theme/css/cid.css">
        <link href="https://calculensis.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="the decision blog Atom Feed" />
        <link href="https://calculensis.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="the decision blog RSS Feed" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

            <div class="container">

<header class="blog-header">
    <h1><a href="https://calculensis.github.io">the decision blog</a></h1>
    <p></p>
    <nav>
        <a href="https://calculensis.github.io/">INDEX</a>
        <a href="https://calculensis.github.io/archives">ARCHIVES</a>
        <a href="https://calculensis.github.io/categories">CATEGORIES</a>
    </nav>
</header>

    <div class="post">

        <header>
            <h1>using a convolutional network for mechanistic interpretability</h1>
            <p class="date">Written on <time datetime="2023-03-16T00:00:00-04:00">Mar 16, 2023</time></p>
        </header>

        <article>
            <p><img align=right src="images/through_a_sphere.jpg" width="200"/></p>
<p>I've been thinking a lot lately about mechanistic interpretability, that is, how to make the internal workings of neural nets transparent to humans. For this post, let's explore one idea in this direction: using a convolutional net to predict the inputs and outputs of a different, target network, based on its internal activations. To keep things simple, for our target network we'll use a binary operation learner and train it on modulo two addition. First we'll import some libraries and set up the network architecture.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="c1"># the number of layers must be at least three</span>
<span class="n">num_layers</span>    <span class="o">=</span> <span class="mi">7</span>
<span class="c1"># number of neurons in the hidden, input, and output layers</span>
<span class="n">num_hidden</span>    <span class="o">=</span> <span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span>
<span class="c1"># modulus for the binary arithmetic operation</span>
<span class="n">modulus</span>       <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_input</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">modulus</span>
<span class="n">num_output</span>    <span class="o">=</span> <span class="n">modulus</span>
<span class="n">layers_list</span>   <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_input</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span>
    <span class="n">layers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="n">weights_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">weight_corrects_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_input</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">)):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_output</span><span class="p">))</span><span class="o">-</span><span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span><span class="o">-</span><span class="mf">1.0</span>
    <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">weight_corrects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">)))</span>
</code></pre></div>

<p>Now let's define the usual activation functions as well as set up the training and test sets. We will one-hot encode the inputs and outputs.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># layer_type = 1 will return tanh (or its derivative)</span>
<span class="c1"># layer_type = 2 will return softmax (or its derivative)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">activ_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">layer_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">layer_type</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_type</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">activ_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">layer_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">layer_type</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_type</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">soft_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">soft_max</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">soft_max</span><span class="p">)</span>

<span class="n">num_train</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">num_test</span>  <span class="o">=</span> <span class="mi">10000</span>
<span class="n">Xtrain_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">modulus</span><span class="p">,(</span><span class="n">num_train</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">Xtest_pre</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">modulus</span><span class="p">,(</span><span class="n">num_test</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ytrain_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">Xtrain_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Xtrain_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">modulus</span><span class="p">)</span>
<span class="n">ytest_pre</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">Xtest_pre</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Xtest_pre</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">modulus</span><span class="p">)</span>
<span class="n">Xtrain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_train</span><span class="p">,</span><span class="n">num_input</span><span class="p">))</span>
<span class="n">Xtest</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_test</span><span class="p">,</span><span class="n">num_input</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_train</span><span class="p">):</span>
    <span class="n">Xtrain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">Xtrain_pre</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="n">Xtrain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">Xtrain_pre</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">modulus</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_test</span><span class="p">):</span>
    <span class="n">Xtest</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">Xtest_pre</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="n">Xtest</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">Xtest_pre</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">modulus</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>

<span class="c1"># one-hot encode the target outputs</span>
<span class="n">ytrain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_train</span><span class="p">,</span><span class="n">modulus</span><span class="p">))</span>
<span class="n">ytest</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_test</span><span class="p">,</span><span class="n">modulus</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_train</span><span class="p">):</span>
    <span class="n">ytrain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ytrain_pre</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mf">1.0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_test</span><span class="p">):</span>
    <span class="n">ytest</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ytest_pre</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mf">1.0</span>
</code></pre></div>

<p>With these in place we can train the model.</p>
<div class="highlight"><pre><span></span><code><span class="n">alpha</span>     <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">err_tol</span>   <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">max_iter</span>  <span class="o">=</span> <span class="mi">500</span>
<span class="n">iter_num</span>  <span class="o">=</span> <span class="mi">0</span>
<span class="n">err</span>       <span class="o">=</span> <span class="mf">1.e5</span>
<span class="k">while</span> <span class="p">((</span><span class="n">iter_num</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">err</span><span class="o">&gt;</span><span class="n">err_tol</span><span class="p">)):</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_train</span><span class="p">):</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xtrain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> \
                               <span class="n">weights_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> \
                       <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># backprop step</span>
        <span class="c1"># form the diagonal activation derivative matrices</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ytrain</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ytrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">diag_activs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># NB: the ith entry in diag_activs corresponds to the</span>
        <span class="c1">#     (i+1)th layer, so entry 0 is for the 1st layer, etc</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">activ_der</span> <span class="o">=</span> <span class="n">activ_deriv</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">diag_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">activ_der</span><span class="p">)</span>
            <span class="n">diag_activs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diag_mat</span><span class="p">)</span>

        <span class="n">activ_der</span> <span class="o">=</span> <span class="n">activ_deriv</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">diag_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">activ_der</span><span class="p">)</span>
        <span class="n">diag_activs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diag_mat</span><span class="p">)</span>

        <span class="c1"># form the products of the weights and diagonals</span>
        <span class="n">mat_prods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">mat_prods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="n">diag_activs</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">mat2</span> <span class="o">=</span> <span class="n">diag_activs</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">j</span><span class="p">]</span>
            <span class="n">new_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat1</span><span class="p">,</span><span class="n">mat2</span><span class="p">)</span>
            <span class="n">tot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_prods</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">new_mat</span><span class="p">)</span>
            <span class="n">mat_prods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_mat</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights_list</span><span class="p">)):</span>
            <span class="n">weight_corrects_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                <span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">],</span> \
                                <span class="n">mat_prods</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight_corrects_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">err</span> <span class="o">+=</span> <span class="p">(</span><span class="n">delta</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">err</span> <span class="o">/=</span> <span class="n">num_train</span>
    <span class="c1">#print(iter_num,err)</span>

    <span class="n">iter_num</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converged on iteration: &#39;</span><span class="p">,</span><span class="n">iter_num</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;training set error: &#39;</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>converged on iteration:  13
training set error:  0.07214775530824573
</code></pre></div>

<p>Let's see how well the model does on the test set.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># check how well the model predicts out of sample</span>
<span class="n">num_correct</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_test</span><span class="p">):</span>
    <span class="n">layers_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xtest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> \
                           <span class="n">weights_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> \
                   <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">pred_answer</span> <span class="o">=</span> <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">true_answer</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pred_answer</span><span class="o">==</span><span class="n">true_answer</span><span class="p">):</span>
        <span class="n">num_correct</span> <span class="o">+=</span> <span class="mf">1.0</span>

<span class="n">percent_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_correct</span><span class="o">/</span><span class="n">num_test</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;percent correct out of sample: &#39;</span><span class="p">,</span><span class="n">percent_correct</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>percent correct out of sample:  100.0
</code></pre></div>

<p>Good, it's learned how to do binary addition correctly. We can save the parameters for later like so.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;weights.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">weights_list</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Xtest.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Xtest</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ytest.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ytest</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>

<p>Now that we have a working model, we need to save its activations to be viewed by the convolutional net and put its inputs/outputs in the correct format: Both the inputs and outputs of the modular addition network will be outputs for our the convolutional network.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;weights.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">weights_list</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;Xtest.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">Xtest</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ytest.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">ytest</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">num_weights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_list</span><span class="p">)</span>
<span class="n">num_input</span>   <span class="o">=</span> <span class="n">weights_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">num_output</span>  <span class="o">=</span> <span class="n">weights_list</span><span class="p">[</span><span class="n">num_weights</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">num_hidden</span>  <span class="o">=</span> <span class="n">weights_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">num_layers</span>  <span class="o">=</span> <span class="n">num_weights</span><span class="o">+</span><span class="mi">1</span>

<span class="n">layers_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_weights</span><span class="p">):</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">weights_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">layers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_output</span><span class="p">))</span>
<span class="n">layers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">activ_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">layer_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">layer_type</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_type</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">activ_mat</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span>
<span class="n">X_conv</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span>
<span class="n">y_conv</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num_input</span><span class="o">+</span><span class="n">num_output</span><span class="p">))</span>
<span class="n">num_correct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">layers_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xtest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> \
                         <span class="n">weights_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> \
            <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">y_conv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">num_input</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xtest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">y_conv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">num_input</span><span class="p">:</span><span class="n">num_input</span><span class="o">+</span><span class="n">num_output</span><span class="p">]</span><span class="o">=</span> \
            <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_hidden</span><span class="p">):</span>
        <span class="n">activ_mat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X_conv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">activ_mat</span>

    <span class="n">num_pred</span> <span class="o">=</span> <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">num_test</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">num_pred</span><span class="o">==</span><span class="n">num_test</span><span class="p">):</span>
        <span class="n">num_correct</span> <span class="o">+=</span> <span class="mf">1.0</span>

<span class="n">percent_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_correct</span><span class="o">/</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">100.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;percent correct on test set: &quot;</span><span class="p">,</span><span class="n">percent_correct</span><span class="p">)</span>

<span class="c1"># save the weights and the test data</span>
<span class="n">X_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">X_conv</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
<span class="n">y_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">y_conv</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s2">&quot;X_conv&quot;</span><span class="p">,</span><span class="n">X_conv</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s2">&quot;y_conv&quot;</span><span class="p">,</span><span class="n">y_conv</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>percent correct on test set:  100.0
</code></pre></div>

<p>That last print statement was just to make sure that we have in fact saved the correct activations! It's time to introduce our convolutional net and see if can learn the inputs and outputs from the activations of the target network.</p>
<div class="highlight"><pre><span></span><code><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># load X_conv and y_conv</span>
<span class="n">Xconv_load</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;X_conv.npz&#39;</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">yconv_load</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;y_conv.npz&#39;</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">Xconv</span> <span class="o">=</span> <span class="n">Xconv_load</span><span class="p">[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
<span class="n">yconv</span> <span class="o">=</span> <span class="n">yconv_load</span><span class="p">[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="n">num_total</span> <span class="o">=</span> <span class="n">Xconv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">num_soft_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yconv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_total</span><span class="p">):</span>
   <span class="n">max_ind</span> <span class="o">=</span> <span class="n">yconv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
   <span class="n">yconv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
   <span class="n">yconv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="o">+</span><span class="n">max_ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># set up the training and test samples</span>
<span class="n">percent_train</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">num_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">num_total</span><span class="o">*</span><span class="n">percent_train</span><span class="p">))</span>
<span class="n">num_test</span>  <span class="o">=</span> <span class="n">num_total</span><span class="o">-</span><span class="n">num_train</span>
<span class="n">Xtrain</span>    <span class="o">=</span> <span class="n">Xconv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_train</span><span class="p">]</span>
<span class="n">ytrain</span>    <span class="o">=</span> <span class="n">yconv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_train</span><span class="p">]</span>
<span class="n">Xtest</span>     <span class="o">=</span> <span class="n">Xconv</span><span class="p">[</span><span class="n">num_train</span><span class="p">:</span><span class="n">num_train</span><span class="o">+</span><span class="n">num_test</span><span class="p">]</span>
<span class="n">ytest</span>     <span class="o">=</span> <span class="n">yconv</span><span class="p">[</span><span class="n">num_train</span><span class="p">:</span><span class="n">num_train</span><span class="o">+</span><span class="n">num_test</span><span class="p">]</span>

<span class="c1"># moving window of size frame_rows x frame_cols moves over</span>
<span class="c1"># every position in the image, such that the frame does not</span>
<span class="c1"># move outside the image, and captures part of the image</span>
<span class="c1"># for each of those positions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">capture_frames</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">):</span>
    <span class="n">image_rows</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">image_cols</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">frame_pos_horz</span> <span class="o">=</span> <span class="n">image_cols</span><span class="o">-</span><span class="n">frame_cols</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">frame_pos_vert</span> <span class="o">=</span> <span class="n">image_rows</span><span class="o">-</span><span class="n">frame_rows</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">captured_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">frame_pos_horz</span><span class="o">*</span><span class="n">frame_pos_vert</span><span class="p">,</span> \
                               <span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame_pos_horz</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame_pos_vert</span><span class="p">):</span>
            <span class="n">single_frame</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">frame_cols</span><span class="p">]</span>
            <span class="n">captured_frames</span><span class="p">[</span><span class="n">frame_pos_vert</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">single_frame</span>
    <span class="k">return</span> <span class="n">captured_frames</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">frame_pos_horz</span><span class="o">*</span><span class="n">frame_pos_vert</span><span class="p">,</span> \
                                   <span class="n">frame_rows</span><span class="o">*</span><span class="n">frame_cols</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># define the activation functions and their derivatives</span>
<span class="c1"># layer_num = 1 will return the function for layer 1 and</span>
<span class="c1"># layer_num = 2 will return that for layer 2</span>
<span class="k">def</span><span class="w"> </span><span class="nf">activ_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">layer_num</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">layer_num</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_num</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">num_soft_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">soft_max1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">num_soft_max</span><span class="p">])</span> \
                <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">num_soft_max</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">soft_max2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">])</span> \
                <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">soft_max3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">])</span> \
                <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">soft_max1</span> <span class="o">=</span> <span class="n">soft_max1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_soft_max</span><span class="p">)</span>
        <span class="n">soft_max2</span> <span class="o">=</span> <span class="n">soft_max2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_soft_max</span><span class="p">)</span>
        <span class="n">soft_max3</span> <span class="o">=</span> <span class="n">soft_max3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_soft_max</span><span class="p">)</span>
        <span class="n">out_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">soft_max1</span><span class="p">,</span><span class="n">soft_max2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">out_vec</span><span class="p">,</span><span class="n">soft_max3</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">activ_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">layer_num</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">layer_num</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_num</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">soft_max</span> <span class="o">=</span> <span class="n">activ_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">num_soft_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">soft_deriv</span> <span class="o">=</span> <span class="n">soft_max</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">soft_max</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">soft_deriv</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dirac_delta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>

<span class="n">init_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">frame_rows</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">frame_cols</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_kernels</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">image_rows</span> <span class="o">=</span> <span class="n">Xtrain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">image_cols</span> <span class="o">=</span> <span class="n">Xtrain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">frame_pos_horz</span> <span class="o">=</span> <span class="n">image_cols</span><span class="o">-</span><span class="n">frame_cols</span><span class="o">+</span><span class="mi">1</span>
<span class="n">frame_pos_vert</span> <span class="o">=</span> <span class="n">image_rows</span><span class="o">-</span><span class="n">frame_rows</span><span class="o">+</span><span class="mi">1</span>
<span class="c1"># N.B.: if the weights are initialized lying too close together,</span>
<span class="c1"># gradient descent will not find many distinct kernels!</span>
<span class="n">kernels</span> <span class="o">=</span> <span class="n">init_factor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_kernels</span><span class="p">,</span> \
                      <span class="n">frame_rows</span><span class="o">*</span><span class="n">frame_cols</span><span class="p">))</span><span class="o">-</span><span class="n">init_factor</span><span class="o">/</span><span class="mf">2.0</span>
<span class="n">grad_kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">frame_rows</span><span class="o">*</span><span class="n">frame_cols</span><span class="p">))</span>

<span class="c1">#set up the fully connected layers</span>

<span class="c1"># the number of layers must be at least three</span>
<span class="n">num_layers</span>    <span class="o">=</span> <span class="mi">4</span>
<span class="c1"># number of neurons in the hidden, input, and output layers</span>
<span class="n">num_hidden</span>    <span class="o">=</span> <span class="mi">30</span>
<span class="n">num_input</span>     <span class="o">=</span> <span class="n">frame_pos_horz</span><span class="o">*</span><span class="n">frame_pos_vert</span>
<span class="n">num_output</span>    <span class="o">=</span> <span class="n">ytrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">layers_list</span>   <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_input</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span>
    <span class="n">layers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="n">weights_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">weight_corrects_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">init_factor</span><span class="o">*</span> \
           <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_input</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span><span class="o">-</span><span class="n">init_factor</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">)):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">init_factor</span><span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_output</span><span class="p">))</span><span class="o">-</span><span class="n">init_factor</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">init_factor</span><span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">))</span><span class="o">-</span><span class="n">init_factor</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">weight_corrects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_hidden</span><span class="p">,</span><span class="n">num_hidden</span><span class="p">)))</span>
</code></pre></div>

<p>So far we've just set up the architecture; now for the learning part.</p>
<div class="highlight"><pre><span></span><code><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">max_iter</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">err_tol</span>  <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">err</span> <span class="o">=</span> <span class="mf">1000.0</span>
<span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dropout</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="p">((</span><span class="nb">iter</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">err</span><span class="o">&gt;</span><span class="n">err_tol</span><span class="p">)):</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Xtrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># forward propagation convolution + pooling steps</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Xtrain</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">image_frames</span> <span class="o">=</span> <span class="n">capture_frames</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> \
                                      <span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">)</span>

        <span class="c1"># form layer_0 pre-pooling step</span>
        <span class="n">layer_0_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">image_frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">):</span>
            <span class="n">layer_0_pre</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">k</span><span class="p">])),</span> \
                          <span class="n">image_frames</span><span class="p">)</span>
        <span class="n">which_kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">layer_0_pre</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># pooling step</span>
        <span class="n">layer_0</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">layer_0_pre</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">layer_0_pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">layer_0</span> <span class="o">=</span> <span class="n">activ_func</span><span class="p">(</span><span class="n">layer_0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># forward propagation to the other layers</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> \
                               <span class="n">weights_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> \
                       <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># set dropout mask for the hidden layers that all have</span>
        <span class="c1"># the same size</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dropout</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">mask_rows</span> <span class="o">=</span> <span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span>
            <span class="n">mask_cols</span> <span class="o">=</span> <span class="n">num_hidden</span>
            <span class="n">dropout_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> \
                                            <span class="p">(</span><span class="n">mask_rows</span><span class="p">,</span><span class="n">mask_cols</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mask_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">layers_list</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">dropout_mask</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">layers_list</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="c1"># backprop step for the fully connected neurons</span>
        <span class="c1"># form the diagonal activation derivative matrices</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ytrain</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ytrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">diag_activs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">activ_der</span> <span class="o">=</span> <span class="n">activ_deriv</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">diag_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">activ_der</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">diag_activs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diag_mat</span><span class="p">)</span>
        <span class="n">activ_der</span> <span class="o">=</span> <span class="n">activ_deriv</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">diag_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">activ_der</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">diag_activs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diag_mat</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dropout</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mask_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">diag_activs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dropout_mask</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">diag_activs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="c1"># form the products of the weights and diagonals</span>
        <span class="n">mat_prods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">mat_prods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="n">diag_activs</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">mat2</span> <span class="o">=</span> <span class="n">diag_activs</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">]</span>
            <span class="n">new_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat1</span><span class="p">,</span><span class="n">mat2</span><span class="p">)</span>
            <span class="n">tot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_prods</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">new_mat</span><span class="p">)</span>
            <span class="n">mat_prods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_mat</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights_list</span><span class="p">)):</span>
            <span class="n">weight_corrects_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                <span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">],</span> \
                                <span class="n">mat_prods</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight_corrects_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># backprop step for the kernel corrections</span>
        <span class="n">grad_kernel_indices</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">grad_kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">grad_kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">which_kernel</span><span class="o">==</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
            <span class="n">image_frames_masked</span> <span class="o">=</span> <span class="n">image_frames</span><span class="o">*</span><span class="n">mask</span>
            <span class="n">mat_prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">weights_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">diag_activs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">diag_activs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">new_prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">weights_list</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">diag_activs</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                <span class="n">mat_prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">new_prod</span><span class="p">,</span><span class="n">mat_prod</span><span class="p">)</span>
            <span class="n">mat_prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_prod</span><span class="p">,</span><span class="n">image_frames_masked</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">grad_kernel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="n">mat_prod</span><span class="p">)</span>
        <span class="n">kernels</span> <span class="o">-=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">grad_kernel</span>

        <span class="n">err</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">/=</span> <span class="n">Xtrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print(iter,err)</span>
    <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&lt;</span><span class="n">max_iter</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;converged at iteration: &quot;</span><span class="p">,</span><span class="nb">iter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;average error: &quot;</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;failed to converge&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>converged at iteration:  13
average error:  0.07639752245626674
</code></pre></div>

<p>Let's see how well the convolutional net does out of sample.</p>
<div class="highlight"><pre><span></span><code><span class="n">err</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">num_correct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="c1"># forward propagation convolution + pooling steps</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Xtest</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image_rows</span><span class="p">,</span><span class="n">image_cols</span><span class="p">)</span>
    <span class="n">image_frames</span> <span class="o">=</span> <span class="n">capture_frames</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> \
                                  <span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">)</span>

    <span class="c1"># form layer_0 pre-pooling step</span>
    <span class="n">layer_0_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">image_frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">):</span>
        <span class="n">layer_0_pre</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">k</span><span class="p">])),</span> \
                      <span class="n">image_frames</span><span class="p">)</span>
    <span class="n">which_kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">layer_0_pre</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># pooling step</span>
    <span class="n">layer_0</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">layer_0_pre</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">layer_0_pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># forward propagation to the other layers</span>
    <span class="n">layers_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> \
                           <span class="n">weights_list</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">activ_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> \
                   <span class="n">weights_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">-</span><span class="n">ytest</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="n">err</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="n">num_pred1</span> <span class="o">=</span> \
            <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span> \
                                      <span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">num_pred2</span> <span class="o">=</span> \
            <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">num_soft_max</span><span class="p">:</span> \
                                      <span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">num_pred3</span> <span class="o">=</span> \
            <span class="n">layers_list</span><span class="p">[</span><span class="n">num_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">:</span> \
                                        <span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

    <span class="n">num_test1</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">num_test2</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">num_test3</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">num_soft_max</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">num_pred1</span><span class="o">==</span><span class="n">num_test1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">num_pred2</span><span class="o">==</span><span class="n">num_test2</span><span class="p">)</span><span class="o">&amp;</span> \
        <span class="p">(</span><span class="n">num_pred3</span><span class="o">==</span><span class="n">num_test3</span><span class="p">)):</span>
        <span class="n">num_correct</span> <span class="o">+=</span> <span class="mf">1.0</span>
<span class="n">err</span> <span class="o">/=</span> <span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;average test set error:&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
<span class="n">percent_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_correct</span><span class="o">/</span><span class="n">Xtest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">100.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;percent correct out of sample: &quot;</span><span class="p">,</span><span class="n">percent_correct</span><span class="p">)</span>

<span class="c1"># save the kernels in csv format</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">kernels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span>
<span class="n">kernels</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;kernels.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>average test set error: 0.08838018565360375
percent correct out of sample:  100.0
</code></pre></div>

<p>Okay good, our model can predict both the inputs and the outputs of the modular addition net from its hidden neuron activations. This model uses three kernels; let's see how the activations look when filtered by these kernels, for all four possible inputs and outputs to the modular addition net.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span><span class="p">;</span> <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="c1"># load X_conv and y_conv</span>
<span class="n">Xconv_load</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;X_conv.npz&#39;</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">yconv_load</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;y_conv.npz&#39;</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">Xconv</span> <span class="o">=</span> <span class="n">Xconv_load</span><span class="p">[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
<span class="n">yconv</span> <span class="o">=</span> <span class="n">yconv_load</span><span class="p">[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="c1"># set up the training and test samples</span>
<span class="n">percent_train</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">num_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Xconv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span><span class="p">))</span>
<span class="n">num_test</span>  <span class="o">=</span> <span class="n">Xconv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">num_train</span>
<span class="n">Xtrain</span>    <span class="o">=</span> <span class="n">Xconv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_train</span><span class="p">]</span>
<span class="n">ytrain</span>    <span class="o">=</span> <span class="n">yconv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_train</span><span class="p">]</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_kernels</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">):</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;kernels.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="n">kernels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">)</span>

    <span class="n">num_plot_rows</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">num_kernels</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">num_plot_cols</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_plot_rows</span><span class="p">,</span><span class="n">num_plot_cols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">num_kernels</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">kernels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;kernels.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">num_kernels</span> <span class="o">=</span> <span class="n">kernels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">frame_rows</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">frame_cols</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">def</span><span class="w"> </span><span class="nf">capture_frames</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">):</span>
    <span class="n">image_rows</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">image_cols</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">frame_pos_horz</span> <span class="o">=</span> <span class="n">image_cols</span><span class="o">-</span><span class="n">frame_cols</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">frame_pos_vert</span> <span class="o">=</span> <span class="n">image_rows</span><span class="o">-</span><span class="n">frame_rows</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">captured_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">frame_pos_horz</span><span class="o">*</span><span class="n">frame_pos_vert</span><span class="p">,</span> \
                                   <span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame_pos_horz</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame_pos_vert</span><span class="p">):</span>
            <span class="n">single_frame</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">frame_cols</span><span class="p">]</span>
            <span class="n">captured_frames</span><span class="p">[</span><span class="n">frame_pos_vert</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">single_frame</span>
    <span class="k">return</span> <span class="n">captured_frames</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">frame_pos_horz</span><span class="o">*</span><span class="n">frame_pos_vert</span><span class="p">,</span> \
                                   <span class="n">frame_rows</span><span class="o">*</span><span class="n">frame_cols</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">92</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">7993</span><span class="p">,</span><span class="mi">85</span><span class="p">])</span>
<span class="n">plot_list</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">title_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_plot</span><span class="p">)):</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">to_plot</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Xtrain</span><span class="p">[</span><span class="n">current</span><span class="p">]</span>
    <span class="c1">#print(&quot;ytrain: &quot;,ytrain[current].round())</span>
    <span class="n">image_frames</span> <span class="o">=</span> <span class="n">capture_frames</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">frame_rows</span><span class="p">,</span><span class="n">frame_cols</span><span class="p">)</span>

    <span class="n">layer_0_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">image_frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">):</span>
        <span class="n">layer_0_pre</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="n">k</span><span class="p">])),</span> \
                      <span class="n">image_frames</span><span class="p">)</span>

    <span class="n">image_rows</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">image_cols</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">filtered_rows</span> <span class="o">=</span> <span class="n">image_rows</span><span class="o">-</span><span class="n">frame_rows</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">filtered_cols</span> <span class="o">=</span> <span class="n">image_cols</span><span class="o">-</span><span class="n">frame_cols</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">filtered_img</span> <span class="o">=</span> <span class="n">layer_0_pre</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">,</span><span class="n">filtered_rows</span><span class="p">,</span> \
                                                   <span class="n">filtered_cols</span><span class="p">)</span>
    <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtered_img</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ytrain</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">())</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">)</span> <span class="o">+</span> \
           <span class="nb">str</span><span class="p">(</span><span class="n">ytrain</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">())</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">)</span> <span class="o">+</span> \
           <span class="nb">str</span><span class="p">(</span><span class="n">ytrain</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">())</span>
    <span class="n">title_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">num_plot_rows</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">num_plot_cols</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_plot_rows</span><span class="p">,</span><span class="n">num_plot_cols</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
    <span class="n">current_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">num_plot_cols</span><span class="p">)</span>
    <span class="n">current_col</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">num_plot_cols</span>
    <span class="n">current_image</span> <span class="o">=</span> <span class="n">plot_list</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">current_image</span><span class="p">[</span><span class="n">current_col</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current_col</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
       <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">title_list</span><span class="p">[</span><span class="n">current_row</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="./images/filtered_activations.png"></p>
<p>The differences in the filtered activations across the operations are subtle. For example, the lower left corner of the leftmost kernel is darker for "1 + 0 = 1" and "0 + 1 = 1" than for "0 + 0 = 0" or "1 + 1 = 0". Given "heat maps" like these, perhaps it would be possible to label the internal states similarly to how we might hope to determine what a human is perceiving and thinking on the basis of functional MRI images.</p>
        </article>

        <footer>
            <p>This entry is posted in <a href="https://calculensis.github.io/category/machine-learning.html">machine learning</a>.</p>
        </footer>


    </div>


<footer class="blog-footer">

    <ul class="nav">
    </ul>

    <p class="disclaimer">
    Built with <a href="http://getpelican.com">Pelican</a>, and <a href="https://github.com/hdra/Pelican-Cid">Cid</a> theme.
    </p>
</footer>
            </div>
<script>
    var _gaq=[['_setAccount','UA-234119846-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
    </body>
</html>